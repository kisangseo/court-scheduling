<!DOCTYPE html>
<html>
<head>
    <title>Court Assignment Search</title>
<style>
#csoDetailTable td {
    height: 35px;
}

#assignmentRosterLayout {
    display: flex;
    gap: 24px;
    align-items: flex-start;
}

#assignmentsPanel {
    width: 70%;
}

#rosterPanel {
    width: 30%;
}

.roster-item {
    padding: 4px 0;
}

.roster-section-title {
    margin: 12px 0 4px;
}

.roster-item.assigned {
    opacity: 0.45;
}

.editable {
    min-height: 28px;
}

.assignment-chip {
    padding: 2px 6px;
    background: #eef3ff;
    border-radius: 4px;
    display: inline-block;
}

.cell-warning {
    color: #b42318;
    font-size: 12px;
    margin-top: 4px;
}
</style>
</head>
<body>

<h2>Search Court Assignments</h2>

<input type="text" id="name" placeholder="Search by Name">
<input type="date" id="date">
<select id="courthouse">
    <option value="">All Courthouses</option>
    <option value="Mitchell">Mitchell</option>
    <option value="Cummings">Cummings</option>
    <option value="Juvenile">Juvenile</option>
</select>
<button onclick="search()">Search</button><button onclick="openRoster()">Roster</button><button onclick="window.open('/staffing', '_blank')">
    Staffing Resources Daily
</button>
<button id="saveAssignments">Save Assignments</button>

<br><br>

<div id="assignmentRosterLayout">
    <div id="assignmentsPanel">
        <div id="results" style="display:flex; gap:40px; align-items:flex-start;"></div>
    </div>
    <div id="rosterPanel">
        <h3>Court Security Roster</h3>
        <label>
            <input type="checkbox" id="showFullRoster">
            Show Full Roster
        </label>
        <div id="rosterList"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let pendingAssignments = {};
let pendingNotes = {};
let allDeputies = [];

function isCourtSecurityDeputy(deputy) {
    const division = (deputy.division || "").trim().toLowerCase();
    const capacityTag = (deputy.capacity_tag || "").trim().toLowerCase();

    return division === "court security"
        || division === "court security division"
        || capacityTag.includes("court security")
        || capacityTag.includes("cso");
}

function getDeputyRole(deputy) {
    return (deputy.role || deputy.capacity_tag || "").trim().toUpperCase();
}

function createRosterItem(deputy) {
    const deputyRow = document.createElement("div");
    deputyRow.className = "roster-item";
    deputyRow.dataset.name = deputy.full_name || "";
    deputyRow.dataset.role = getDeputyRole(deputy);

    const division = (deputy.division || "Unassigned Division").trim() || "Unassigned Division";
    deputyRow.textContent = `${deputy.full_name} - ${division} (${deputy.capacity_tag || ""})`;

    return deputyRow;
}

function getAssignedNameFromCell(cell) {
    const chip = cell.querySelector('.assignment-chip');
    return chip ? (chip.dataset.name || chip.textContent || '').trim() : '';
}

function getAssignedNames() {
    const names = new Set();
    document.querySelectorAll('.editable').forEach(cell => {
        const name = getAssignedNameFromCell(cell);
        if (name) names.add(name);
    });
    return names;
}

function refreshRosterAssignedState() {
    const assignedNames = getAssignedNames();
    document.querySelectorAll('#rosterList .roster-item').forEach(item => {
        const name = (item.dataset.name || '').trim();
        item.classList.toggle('assigned', !!name && assignedNames.has(name));
    });
}

function renderRoster() {
    const rosterList = document.getElementById("rosterList");
    const showFullRoster = document.getElementById("showFullRoster").checked;
    rosterList.innerHTML = "";

    const courtSecurityDeputies = allDeputies.filter(isCourtSecurityDeputy);
    courtSecurityDeputies.forEach(deputy => {
        rosterList.appendChild(createRosterItem(deputy));
    });

    if (showFullRoster) {
        const fullRosterHeading = document.createElement("h4");
        fullRosterHeading.className = "roster-section-title";
        fullRosterHeading.textContent = "Full Roster";
        rosterList.appendChild(fullRosterHeading);

        const nonCourtSecurityDeputies = allDeputies.filter(deputy => !isCourtSecurityDeputy(deputy));
        nonCourtSecurityDeputies.forEach(deputy => {
            rosterList.appendChild(createRosterItem(deputy));
        });
    }

    initRosterDrag();
    refreshRosterAssignedState();
}

function loadRoster() {
    fetch("/api/deputies")
        .then(response => response.json())
        .then(data => {
            allDeputies = (data || []).sort((a, b) =>
                (a.full_name || "").localeCompare(b.full_name || "")
            );
            renderRoster();
        });
}

function getCellAssignmentCategory(cell) {
    if (cell.dataset.type === 'Courtroom') return 'courtroom';
    if (cell.dataset.type === 'Fixed Post') return 'security';
    return 'overtime';
}

function isArmedRole(role) {
    return role === 'DEP' || role === 'SPO';
}

function isEligibleForCell(cell, role) {
    const category = getCellAssignmentCategory(cell);
    if (category === 'courtroom') {
        return isArmedRole(role);
    }
    return true;
}

function showCellWarning(cell, message) {
    const existing = cell.querySelector('.cell-warning');
    if (existing) existing.remove();
    const warning = document.createElement('div');
    warning.className = 'cell-warning';
    warning.textContent = message;
    cell.appendChild(warning);
    setTimeout(() => warning.remove(), 2000);
}

function buildAssignmentChip(name, role) {
    const chip = document.createElement('div');
    chip.className = 'assignment-chip';
    chip.dataset.name = name;
    chip.dataset.role = role || '';
    chip.textContent = name;
    return chip;
}

function setPendingAssignmentFromCell(cell, assignedName) {
    const payload = {
        assignment_date: cell.dataset.date,
        courthouse: cell.dataset.courthouse,
        assignment_type: cell.dataset.type,
        location_detail: cell.dataset.room,
        part: cell.dataset.part,
        assigned_member: assignedName
    };

    const key = [
        payload.assignment_date,
        payload.courthouse,
        payload.assignment_type,
        payload.location_detail,
        payload.part
    ].join('|');

    pendingAssignments[key] = payload;
}

function initAssignmentDropzones() {
    document.querySelectorAll('.editable').forEach(cell => {
        const existingName = cell.textContent.trim();
        cell.innerHTML = '';
        if (existingName) {
            cell.appendChild(buildAssignmentChip(existingName, ''));
        }

        Sortable.create(cell, {
            group: {
                name: 'assignmentRoster',
                pull: false,
                put: (to, from) => from.el.id === 'rosterList'
            },
            animation: 100,
            sort: false,
            onAdd: (evt) => {
                const dropCell = evt.to;
                const item = evt.item;
                const role = (item.dataset.role || '').trim().toUpperCase();
                const assignedName = (item.dataset.name || item.textContent || '').trim();

                if (!isEligibleForCell(dropCell, role)) {
                    item.remove();
                    showCellWarning(dropCell, 'Select eligible personnel');
                    return;
                }

                Array.from(dropCell.children).forEach(child => {
                    if (child !== item && !child.classList.contains('cell-warning')) {
                        child.remove();
                    }
                });

                item.className = 'assignment-chip';
                item.dataset.name = assignedName;
                item.dataset.role = role;
                item.textContent = assignedName;

                setPendingAssignmentFromCell(dropCell, assignedName);
                refreshRosterAssignedState();
            }
        });
    });
}

let rosterSortable = null;
function initRosterDrag() {
    const rosterList = document.getElementById('rosterList');
    if (rosterSortable) {
        rosterSortable.destroy();
    }

    rosterSortable = Sortable.create(rosterList, {
        group: {
            name: 'assignmentRoster',
            pull: 'clone',
            put: false
        },
        animation: 100,
        sort: false,
        filter: '.roster-section-title'
    });
}

function search() {
    const name = document.getElementById("name").value;
    const date = document.getElementById("date").value;
    const courthouse = document.getElementById("courthouse").value;

    fetch(`/api/search?name=${name}&date=${date}&courthouse=${courthouse}`)
        .then(response => response.json())
        .then(data => {

            const container = document.getElementById("results");
            container.innerHTML = "";

            if (!data || data.length === 0) return;

            const grouped = {};

            data.forEach(row => {
                if (!grouped[row.courthouse]) grouped[row.courthouse] = [];
                grouped[row.courthouse].push(row);
            });

            for (const courthouse in grouped) {

                const column = document.createElement("div");
                column.style.width = "50%";

                const header = document.createElement("h3");
                header.textContent = courthouse;
                column.appendChild(header);

                const typeGroups = {};

                grouped[courthouse].forEach(row => {
                    if (!typeGroups[row.assignment_type])
                        typeGroups[row.assignment_type] = [];
                    typeGroups[row.assignment_type].push(row);
                });

                const orderedTypes = ["Fixed Post", "Courtroom", "Overtime"];

                orderedTypes.forEach(type => {

                    if (!typeGroups[type]) return;
                    if (courthouse === "Juvenile" && type === "Fixed Post") return;

                    const typeHeader = document.createElement("h4");
                    typeHeader.textContent = type === "Fixed Post" ? "Security Posts" : type;
                    column.appendChild(typeHeader);

                    /* ================= COURTROOM ================= */
                    if (type === "Courtroom") {

                        let rooms = [];

                        if (courthouse === "Mitchell") {
                            rooms = [
                                "600M","231M","417M","556C","215M","441M","309M",
                                "228C","226M","420M","400M","236M","203M","451M","438M"
                            ];
                        }

                        if (courthouse === "Cummings") {
                            rooms = [
                                "225C","201C","430C","329C","230C","227C",
                                "540C","404C","523C","528C","113C"
                            ];
                        }

                        if (courthouse === "Juvenile") {
                            rooms = ["329C","428M","406M"];
                        }

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Judge</th>
                                    <th>Room / Part</th>
                                    <th>Assignment</th>
                                    <th>Deputy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        rooms.forEach(room => {

                            const row = typeGroups[type].find(r => r.location_detail === room);

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row ? (row.judge_name || "") : ""}</td>
                                <td>${room} ${row && row.part ? "Part " + row.part : ""}</td>
                                <td class="editable-assignment"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Courtroom"
                                    data-room="${room}"
                                    data-part="${row && row.part ? row.part : ""}">
                                    ${row ? (row.assignment_notes || "") : ""}
                                </td>
                                <td class="editable"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Courtroom"
                                    data-room="${room}"
                                    data-part="${row && row.part ? row.part : ""}">
                                    ${row ? (row.assigned_member || "") : ""}
                                </td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                        return;
                    }

                    /* ================= SECURITY POSTS ================= */
                    if (type === "Fixed Post") {

                        let posts = [];

                        if (courthouse === "Mitchell") {
                            posts = [
                                "Calvert",
                                "Lexington",
                                "Fayette H/C Console room",
                                "Lock Up West",
                                "Jury Room",
                                "St. Paul St. Rover",
                                "Judges"
                            ];
                        }

                        if (courthouse === "Cummings") {
                            posts = [
                                "Cummings",
                                "Fayette St. H/C",
                                "Console Room",
                                "Lock Up East",
                                "Garage",
                                "Family Court",
                                "Transportation"
                            ];
                        }

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Security Post</th>
                                    <th>Deputy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        posts.forEach(post => {

                            const assigned = typeGroups[type].find(r => r.location_group === post);

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${post}</td>
                                <td class="editable"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Fixed Post"
                                    data-room="${post}"
                                    data-part="">
                                    ${assigned ? (assigned.assigned_member || "") : ""}
                                </td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                        return;
                    }

                    /* ================= OVERTIME ================= */
                    if (type === "Overtime") {

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Detail</th>
                                    <th>Shift</th>
                                    <th>Member</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        typeGroups[type].forEach(row => {

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.location_detail || ""}</td>
                                <td>${row.shift_time || ""}</td>
                                <td class="editable"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Overtime"
                                    data-room="${row.location_detail}"
                                    data-part="">
                                    ${row.assigned_member || ""}
                                </td>
                                <td class="editable-assignment"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Overtime"
                                    data-room="${row.location_detail || ""}"
                                    data-part="${row.assigned_member || ""}">
                                    ${row.assignment_notes || ""}
                                </td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                    }

                });

                container.appendChild(column);
            }
            initAssignmentDropzones();
            refreshRosterAssignedState();
        });
}

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("date").value = today;
    document.getElementById("showFullRoster").addEventListener("change", renderRoster);
    loadRoster();
    search();
};
document.addEventListener("click", function(e) {

    const cell = e.target.closest(".editable-assignment");
    if (!cell) return;

    if (cell.querySelector("input")) return;

    const input = document.createElement("input");
    input.type = "text";
    input.value = cell.textContent.trim();

    cell.innerHTML = "";
    cell.appendChild(input);
    input.focus();

    input.addEventListener("blur", function() {

        const payload = {
            assignment_date: cell.dataset.date,
            courthouse: cell.dataset.courthouse,
            assignment_type: cell.dataset.type,
            location_detail: cell.dataset.room,
            part: cell.dataset.part,
            assignment_notes: input.value
        };

        const key = [
            payload.assignment_date,
            payload.courthouse,
            payload.assignment_type,
            payload.location_detail,
            payload.part
        ].join("|");

        pendingNotes[key] = payload;
        cell.textContent = input.value;

    });

});

document.getElementById("saveAssignments").addEventListener("click", function() {

    const invalidSecurityCells = [];
    document.querySelectorAll('.editable[data-type="Fixed Post"]').forEach(cell => {
        const assignedName = getAssignedNameFromCell(cell);
        if (!assignedName) {
            invalidSecurityCells.push(cell.dataset.room || "Security Post");
            return;
        }

        const deputy = allDeputies.find(dep => (dep.full_name || "") === assignedName);
        const role = ((deputy && (deputy.role || deputy.capacity_tag)) || cell.querySelector('.assignment-chip')?.dataset.role || "")
            .trim()
            .toUpperCase();

        if (!isArmedRole(role)) {
            invalidSecurityCells.push(cell.dataset.room || "Security Post");
        }
    });

    if (invalidSecurityCells.length > 0) {
        alert(`Each security post must have at least one armed person (DEP/SPO). Check: ${invalidSecurityCells.join(', ')}`);
        return;
    }

    const assignmentRequests = Object.values(pendingAssignments).map(payload =>
        fetch("/api/update-deputy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(res => {
            if (!res.ok) throw new Error("Failed to save deputy assignment");
            return res.json();
        })
    );

    const notesRequests = Object.values(pendingNotes).map(payload =>
        fetch("/api/update-assignment-notes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(res => {
            if (!res.ok) throw new Error("Failed to save assignment note");
            return res.json();
        })
    );

    Promise.all([...assignmentRequests, ...notesRequests])
        .then(() => {
            pendingAssignments = {};
            pendingNotes = {};
        })
        .catch(err => {
            console.error("Save failed:", err);
        });
});

function openRoster() {
    window.open("/roster", "_blank");
}
</script>
<hr>

<h2>CSO Detail - Borrowed Deputies</h2>

<table border="1" id="csoDetailTable">
    <thead>
        <tr>
            <th>Deputy Name</th>
            <th>Building</th>
            <th>Assignment Type</th>
            <th>Room / Post / Part</th>
        </tr>
    </thead>
    <tbody id="csoDetailBody">
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
</tbody>
</table>
</body>
</html>
