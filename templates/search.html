<!DOCTYPE html>
<html>
<head>
    <title>Court Assignment Search</title>
</head>
<body>

<h2>Search Court Assignments</h2>

<input type="text" id="name" placeholder="Search by Name">
<input type="date" id="date">
<select id="courthouse">
    <option value="">All Courthouses</option>
    <option value="Mitchell">Mitchell</option>
    <option value="Cummings">Cummings</option>
    <option value="Juvenile">Juvenile</option>
</select>
<button onclick="search()">Search</button>

<br><br>

<div id="results" style="display:flex; gap:40px; align-items:flex-start;"></div>

<script>
function search() {
    const name = document.getElementById("name").value;
    const date = document.getElementById("date").value;
    const courthouse = document.getElementById("courthouse").value;

    fetch(`/api/search?name=${name}&date=${date}&courthouse=${courthouse}`)
        .then(response => response.json())
        .then(data => {

            const container = document.getElementById("results");
            container.innerHTML = "";

            if (!data || data.length === 0) return;

            const grouped = {};

            data.forEach(row => {
                if (!grouped[row.courthouse]) grouped[row.courthouse] = [];
                grouped[row.courthouse].push(row);
            });

            for (const courthouse in grouped) {

                const column = document.createElement("div");
                column.style.width = "50%";

                const header = document.createElement("h3");
                header.textContent = courthouse;
                column.appendChild(header);

                const typeGroups = {};

                grouped[courthouse].forEach(row => {
                    if (!typeGroups[row.assignment_type])
                        typeGroups[row.assignment_type] = [];
                    typeGroups[row.assignment_type].push(row);
                });

                const orderedTypes = ["Fixed Post", "Courtroom", "Overtime"];

                orderedTypes.forEach(type => {

                    if (!typeGroups[type]) return;
                    if (courthouse === "Juvenile" && type === "Fixed Post") return;

                    const typeHeader = document.createElement("h4");
                    typeHeader.textContent = type === "Fixed Post" ? "Security Posts" : type;
                    column.appendChild(typeHeader);

                    /* ================= COURTROOM ================= */
                    if (type === "Courtroom") {

                        let rooms = [];

                        if (courthouse === "Mitchell") {
                            rooms = [
                                "600M","231M","417M","556C","215M","441M","309M",
                                "228C","226M","420M","400M","236M","203M","451M","438M"
                            ];
                        }

                        if (courthouse === "Cummings") {
                            rooms = [
                                "225C","201C","430C","329C","230C","227C",
                                "540C","404C","523C","528C","113C"
                            ];
                        }

                        if (courthouse === "Juvenile") {
                            rooms = ["329C","428M","406M"];
                        }

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Judge</th>
                                    <th>Room / Part</th>
                                    <th>Assignment</th>
                                    <th>Deputy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        rooms.forEach(room => {

                            const row = typeGroups[type].find(r => r.location_detail === room);

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row ? (row.judge_name || "") : ""}</td>
                                <td>${room} ${row && row.part ? "Part " + row.part : ""}</td>
                                <td>${row ? (row.assignment_notes || "") : ""}</td>
                                <td>${row ? (row.assigned_member || "") : ""}</td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                        return;
                    }

                    /* ================= SECURITY POSTS ================= */
                    if (type === "Fixed Post") {

                        let posts = [];

                        if (courthouse === "Mitchell") {
                            posts = [
                                "Calvert",
                                "Lexington",
                                "Fayette H/C Console room",
                                "Lock Up West",
                                "Jury Room",
                                "St. Paul St. Rover",
                                "Judges"
                            ];
                        }

                        if (courthouse === "Cummings") {
                            posts = [
                                "Cummings",
                                "Fayette St. H/C",
                                "Console Room",
                                "Lock Up East",
                                "Garage",
                                "Family Court",
                                "Transportation"
                            ];
                        }

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Security Post</th>
                                    <th>Deputy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        posts.forEach(post => {

                            const assigned = typeGroups[type].find(r => r.location_group === post);

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${post}</td>
                                <td>${assigned ? assigned.assigned_member : ""}</td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                        return;
                    }

                    /* ================= OVERTIME ================= */
                    if (type === "Overtime") {

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Detail</th>
                                    <th>Shift</th>
                                    <th>Member</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        typeGroups[type].forEach(row => {

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.location_detail || ""}</td>
                                <td>${row.shift_time || ""}</td>
                                <td>${row.assigned_member || ""}</td>
                                <td>${row.assignment_notes || ""}</td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                    }

                });

                container.appendChild(column);
            }
        });
}

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("date").value = today;
    search();
};
</script>

</body>
</html>