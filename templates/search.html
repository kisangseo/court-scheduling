<!DOCTYPE html>
<html>
<head>
    <title>Court Assignment Search</title>
<style>
#csoDetailTable td {
    height: 35px;
}

#assignmentRosterLayout {
    display: flex;
    gap: 24px;
    align-items: flex-start;
}

#assignmentsPanel {
    width: 70%;
}

#rosterPanel {
    width: 30%;
}

.roster-item {
    padding: 4px 0;
}
</style>
</head>
<body>

<h2>Search Court Assignments</h2>

<input type="text" id="name" placeholder="Search by Name">
<input type="date" id="date">
<select id="courthouse">
    <option value="">All Courthouses</option>
    <option value="Mitchell">Mitchell</option>
    <option value="Cummings">Cummings</option>
    <option value="Juvenile">Juvenile</option>
</select>
<button onclick="search()">Search</button><button onclick="openRoster()">Roster</button><button onclick="window.open('/staffing', '_blank')">
    Staffing Resources Daily
</button>
<button id="saveAssignments">Save Assignments</button>

<br><br>

<div id="assignmentRosterLayout">
    <div id="assignmentsPanel">
        <div id="results" style="display:flex; gap:40px; align-items:flex-start;"></div>
    </div>
    <div id="rosterPanel">
        <h3>Court Security Roster</h3>
        <label>
            <input type="checkbox" id="showFullRoster">
            Show Full Roster
        </label>
        <div id="rosterList"></div>
    </div>
</div>

<script>
let pendingAssignments = {};
let pendingNotes = {};
let allDeputies = [];

function isCourtSecurityDeputy(deputy) {
    const division = (deputy.division || "").trim().toLowerCase();
    const capacityTag = (deputy.capacity_tag || "").trim().toLowerCase();

    return division === "court security"
        || division === "court security division"
        || capacityTag.includes("court security")
        || capacityTag.includes("cso");
}

function renderRoster() {
    const rosterList = document.getElementById("rosterList");
    const showFullRoster = document.getElementById("showFullRoster").checked;
    rosterList.innerHTML = "";

    const deputiesToRender = showFullRoster
        ? allDeputies
        : allDeputies.filter(isCourtSecurityDeputy);

    deputiesToRender.forEach(deputy => {
        const deputyRow = document.createElement("div");
        deputyRow.className = "roster-item";
        deputyRow.textContent = `${deputy.full_name} (${deputy.capacity_tag || ""})`;
        rosterList.appendChild(deputyRow);
    });
}

function loadRoster() {
    fetch("/api/deputies")
        .then(response => response.json())
        .then(data => {
            allDeputies = (data || []).sort((a, b) =>
                (a.full_name || "").localeCompare(b.full_name || "")
            );
            renderRoster();
        });
}

function search() {
    const name = document.getElementById("name").value;
    const date = document.getElementById("date").value;
    const courthouse = document.getElementById("courthouse").value;

    fetch(`/api/search?name=${name}&date=${date}&courthouse=${courthouse}`)
        .then(response => response.json())
        .then(data => {

            const container = document.getElementById("results");
            container.innerHTML = "";

            if (!data || data.length === 0) return;

            const grouped = {};

            data.forEach(row => {
                if (!grouped[row.courthouse]) grouped[row.courthouse] = [];
                grouped[row.courthouse].push(row);
            });

            for (const courthouse in grouped) {

                const column = document.createElement("div");
                column.style.width = "50%";

                const header = document.createElement("h3");
                header.textContent = courthouse;
                column.appendChild(header);

                const typeGroups = {};

                grouped[courthouse].forEach(row => {
                    if (!typeGroups[row.assignment_type])
                        typeGroups[row.assignment_type] = [];
                    typeGroups[row.assignment_type].push(row);
                });

                const orderedTypes = ["Fixed Post", "Courtroom", "Overtime"];

                orderedTypes.forEach(type => {

                    if (!typeGroups[type]) return;
                    if (courthouse === "Juvenile" && type === "Fixed Post") return;

                    const typeHeader = document.createElement("h4");
                    typeHeader.textContent = type === "Fixed Post" ? "Security Posts" : type;
                    column.appendChild(typeHeader);

                    /* ================= COURTROOM ================= */
                    if (type === "Courtroom") {

                        let rooms = [];

                        if (courthouse === "Mitchell") {
                            rooms = [
                                "600M","231M","417M","556C","215M","441M","309M",
                                "228C","226M","420M","400M","236M","203M","451M","438M"
                            ];
                        }

                        if (courthouse === "Cummings") {
                            rooms = [
                                "225C","201C","430C","329C","230C","227C",
                                "540C","404C","523C","528C","113C"
                            ];
                        }

                        if (courthouse === "Juvenile") {
                            rooms = ["329C","428M","406M"];
                        }

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Judge</th>
                                    <th>Room / Part</th>
                                    <th>Assignment</th>
                                    <th>Deputy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        rooms.forEach(room => {

                            const row = typeGroups[type].find(r => r.location_detail === room);

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row ? (row.judge_name || "") : ""}</td>
                                <td>${room} ${row && row.part ? "Part " + row.part : ""}</td>
                                <td class="editable-assignment"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Courtroom"
                                    data-room="${room}"
                                    data-part="${row && row.part ? row.part : ""}">
                                    ${row ? (row.assignment_notes || "") : ""}
                                </td>
                                <td class="editable"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Courtroom"
                                    data-room="${room}"
                                    data-part="${row && row.part ? row.part : ""}">
                                    ${row ? (row.assigned_member || "") : ""}
                                </td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                        return;
                    }

                    /* ================= SECURITY POSTS ================= */
                    if (type === "Fixed Post") {

                        let posts = [];

                        if (courthouse === "Mitchell") {
                            posts = [
                                "Calvert",
                                "Lexington",
                                "Fayette H/C Console room",
                                "Lock Up West",
                                "Jury Room",
                                "St. Paul St. Rover",
                                "Judges"
                            ];
                        }

                        if (courthouse === "Cummings") {
                            posts = [
                                "Cummings",
                                "Fayette St. H/C",
                                "Console Room",
                                "Lock Up East",
                                "Garage",
                                "Family Court",
                                "Transportation"
                            ];
                        }

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Security Post</th>
                                    <th>Deputy</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        posts.forEach(post => {

                            const assigned = typeGroups[type].find(r => r.location_group === post);

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${post}</td>
                                <td class="editable"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Fixed Post"
                                    data-room="${post}"
                                    data-part="">
                                    ${assigned ? (assigned.assigned_member || "") : ""}
                                </td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                        return;
                    }

                    /* ================= OVERTIME ================= */
                    if (type === "Overtime") {

                        const table = document.createElement("table");
                        table.border = "1";

                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Detail</th>
                                    <th>Shift</th>
                                    <th>Member</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");

                        typeGroups[type].forEach(row => {

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${row.location_detail || ""}</td>
                                <td>${row.shift_time || ""}</td>
                                <td class="editable"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Overtime"
                                    data-room="${row.location_detail}"
                                    data-part="">
                                    ${row.assigned_member || ""}
                                </td>
                                <td class="editable-assignment"
                                    data-date="${document.getElementById("date").value}"
                                    data-courthouse="${courthouse}"
                                    data-type="Overtime"
                                    data-room="${row.location_detail || ""}"
                                    data-part="${row.assigned_member || ""}">
                                    ${row.assignment_notes || ""}
                                </td>
                            `;

                            tbody.appendChild(tr);
                        });

                        column.appendChild(table);
                        column.appendChild(document.createElement("br"));
                    }

                });

                container.appendChild(column);
            }
        });
}

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("date").value = today;
    document.getElementById("showFullRoster").addEventListener("change", renderRoster);
    loadRoster();
    search();
};
document.addEventListener("click", function(e) {

    if (!e.target.classList.contains("editable")) return;

    const cell = e.target;

    fetch("/api/deputies-available")
    .then(res => res.json())
    .then(roster => {

        const select = document.createElement("select");

        const blank = document.createElement("option");
        blank.value = "";
        blank.textContent = "-- Select --";
        select.appendChild(blank);

        roster.forEach(dep => {
            const option = document.createElement("option");
            option.value = dep.full_name;
            option.textContent = dep.full_name + " (" + dep.capacity_tag + ")";
            select.appendChild(option);
        });

        select.value = cell.textContent.trim();

        cell.innerHTML = "";
        cell.appendChild(select);
        select.focus();

        select.addEventListener("change", function() {

            const payload = {
                assignment_date: cell.dataset.date,
                courthouse: cell.dataset.courthouse,
                assignment_type: cell.dataset.type,
                location_detail: cell.dataset.room,
                part: cell.dataset.part,
                assigned_member: select.value
            };

            const key = [
                payload.assignment_date,
                payload.courthouse,
                payload.assignment_type,
                payload.location_detail,
                payload.part
            ].join("|");

            pendingAssignments[key] = payload;
            cell.textContent = select.value;
        });
    });
});
document.addEventListener("click", function(e) {

    const cell = e.target.closest(".editable-assignment");
    if (!cell) return;

    if (cell.querySelector("input")) return;

    const input = document.createElement("input");
    input.type = "text";
    input.value = cell.textContent.trim();

    cell.innerHTML = "";
    cell.appendChild(input);
    input.focus();

    input.addEventListener("blur", function() {

        const payload = {
            assignment_date: cell.dataset.date,
            courthouse: cell.dataset.courthouse,
            assignment_type: cell.dataset.type,
            location_detail: cell.dataset.room,
            part: cell.dataset.part,
            assignment_notes: input.value
        };

        const key = [
            payload.assignment_date,
            payload.courthouse,
            payload.assignment_type,
            payload.location_detail,
            payload.part
        ].join("|");

        pendingNotes[key] = payload;
        cell.textContent = input.value;

    });

});

document.getElementById("saveAssignments").addEventListener("click", function() {

    const assignmentRequests = Object.values(pendingAssignments).map(payload =>
        fetch("/api/update-deputy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(res => {
            if (!res.ok) throw new Error("Failed to save deputy assignment");
            return res.json();
        })
    );

    const notesRequests = Object.values(pendingNotes).map(payload =>
        fetch("/api/update-assignment-notes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(res => {
            if (!res.ok) throw new Error("Failed to save assignment note");
            return res.json();
        })
    );

    Promise.all([...assignmentRequests, ...notesRequests])
        .then(() => {
            pendingAssignments = {};
            pendingNotes = {};
        })
        .catch(err => {
            console.error("Save failed:", err);
        });
});

function openRoster() {
    window.open("/roster", "_blank");
}
</script>
<hr>

<h2>CSO Detail - Borrowed Deputies</h2>

<table border="1" id="csoDetailTable">
    <thead>
        <tr>
            <th>Deputy Name</th>
            <th>Building</th>
            <th>Assignment Type</th>
            <th>Room / Post / Part</th>
        </tr>
    </thead>
    <tbody id="csoDetailBody">
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
</tbody>
</table>
</body>
</html>
