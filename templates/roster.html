<!DOCTYPE html>
<html>
<head>
    <title>Deputy Roster</title>
    <style>
        
        .container { display: flex; gap: 24px; align-items: flex-start; }
        .panel { width: 50%; }
        
        
        
        .toolbar { display: flex; gap: 16px; align-items: center; margin-bottom: 10px; }
        .status-counts { font-size: 0.95em; }
        .status-red { color: #b42318; font-weight: 700; }
        .status-group label { margin-right: 8px; display: inline-block; }
        .action-row { display: flex; gap: 6px; margin-top: 6px; }
        .small { font-size: 12px; color: #344054; }
        .add-form { margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
        .status-green {
            color: #067647;
            font-weight: 700;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

<h2>Deputy Roster</h2>
<div class="toolbar">
    <label>
        Date:
        <input type="date" id="rosterDate">
    </label>
</div>

<div class="add-form">
    <input type="text" id="newFullName" placeholder="Full Name">
    <select id="newDivision">
        <option value="Court Security">Court Security</option>
        <option value="Domestic Violence">Domestic Violence</option>
        <option value="Field Services">Field Services</option>
        <option value="Other">Other</option>
    </select>
    <select id="newRank"></select>
    <select id="newCapability"></select>
    <button id="addDeputyBtn" type="button">Add Person</button>
</div>

<div class="container">
    <div class="panel">
        <h3>Court Security <span id="courtSecurityStatusCounts" class="status-counts"></span></h3>
        <table id="courtSecurityTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Rank</th>
                    <th>Capability</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="panel">
        <h3>Other Divisions</h3>
        <table id="otherDivisionsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Division</th>
                    <th>Rank</th>
                    <th>Capability</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const rankOptions = ["Court Security Officer", "Deputy Sheriff", "Sergeant", "Detective"];
const capabilityOptions = ["CSO", "DEP", "SPO", "F", "PATROL", "TRANSPORT", "DET", "SGT"];

function buildOptions(selectEl, values, selectedValue = "") {
    selectEl.innerHTML = "";
    values.forEach(value => {
        const opt = document.createElement("option");
        opt.value = value;
        opt.textContent = value;
        if ((selectedValue || "") === value) opt.selected = true;
        selectEl.appendChild(opt);
    });
}

buildOptions(document.getElementById("newRank"), rankOptions, "Court Security Officer");
buildOptions(document.getElementById("newCapability"), capabilityOptions, "CSO");

function isCourtSecurityDeputy(deputy) {
    const division = (deputy.division || "").trim().toLowerCase();
    const capability = (deputy.capacity_tag || "").trim().toLowerCase();
    return division === "court security"
        || division === "court security division"
        || capability.includes("court security")
        || capability.includes("cso");
}

function parseDateOnly(value) {
    if (!value) return null;
    const d = new Date(`${value}T00:00:00`);
    return Number.isNaN(d.getTime()) ? null : d;
}

function effectiveStatusForSelectedDate(dep) {
    const selectedDate = parseDateOnly(document.getElementById("rosterDate").value);

    try {
        const raw = dep.status_raw;
        const parsed = raw ? JSON.parse(raw) : null;
        const ranges = parsed && Array.isArray(parsed.ranges) ? parsed.ranges : [];

        if (selectedDate) {
            for (let i = ranges.length - 1; i >= 0; i -= 1) {
                const entry = ranges[i];
                const start = parseDateOnly(entry.start_date);
                const end = parseDateOnly(entry.end_date);
                if (start && end && selectedDate >= start && selectedDate <= end) {
                    return entry.status || "";
                }
            }
        }

        if (parsed && parsed.legacy) return parsed.legacy;
    } catch (_) {
        // fallback to effective status from API
    }

    return dep.current_status || "";
}

function statusIncludes(dep, value) {
    return effectiveStatusForSelectedDate(dep).toLowerCase().includes(value.toLowerCase());
}

function renderStatusControls(dep, hostTr) {
    const wrapper = document.createElement("div");
    wrapper.className = "status-group";
    wrapper.innerHTML = `
        <label><input type="checkbox" value="Sick" ${statusIncludes(dep, "Sick") ? "checked" : ""}> Sick</label>
        <label><input type="checkbox" value="Leave" ${statusIncludes(dep, "Leave") ? "checked" : ""}> Leave</label>
        <label><input type="checkbox" value="Light Duty" ${statusIncludes(dep, "Light Duty") ? "checked" : ""}> Light Duty</label>
        <button class="clear-status" type="button">Clear</button>
        <div class="small">Click a status checkbox to set date range.</div>
    `;

    wrapper.querySelectorAll("input[type=checkbox]").forEach(box => {
        box.addEventListener("change", function() {
            if (!box.checked) return;

            const rangeRow = document.createElement("div");
            rangeRow.className = "action-row";
            rangeRow.innerHTML = `
                <input type="date" class="start-date">
                <input type="date" class="end-date">
                <button type="button" class="apply-range">Apply</button>
                <button type="button" class="cancel-range">Cancel</button>
            `;

            const start = rangeRow.querySelector(".start-date");
            const end = rangeRow.querySelector(".end-date");
            const selectedDate = document.getElementById("rosterDate").value;
            start.value = selectedDate;
            end.value = selectedDate;

            rangeRow.querySelector(".apply-range").addEventListener("click", () => {
                if (!start.value || !end.value) {
                    alert("Please select both start and end dates.");
                    return;
                }
                if (start.value > end.value) {
                    alert("Start date must be on or before end date.");
                    return;
                }

                fetch("/api/update-status-range", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        full_name: dep.full_name,
                        status: box.value,
                        start_date: start.value,
                        end_date: end.value
                    })
                })
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to save status range');
                        return res.json();
                    })
                    .then(result => {
                        if (result.removed_assignments && result.removed_assignments > 0) {
                            alert(`Removed from ${result.removed_assignments} assignment(s).`);
                        }

                        loadRoster();

                        // refresh assignments on search page if open
                        if (window.opener && typeof window.opener.search === "function") {
                            window.opener.search();
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Failed to save status range.');
                    });
            });

            rangeRow.querySelector(".cancel-range").addEventListener("click", () => {
                rangeRow.remove();
                box.checked = false;
            });

            wrapper.appendChild(rangeRow);
        });
    });

    wrapper.querySelector(".clear-status").addEventListener("click", function() {
        fetch("/api/update-status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ full_name: dep.full_name, status: null })
        }).then(() => loadRoster());
    });

    return wrapper;
}

function createDeputyRow(dep, includeDivision) {
    const tr = document.createElement("tr");

    const rankDisplay = document.createElement("span");
    rankDisplay.textContent = dep.rank || "";

    const capabilityDisplay = document.createElement("span");
    capabilityDisplay.textContent = dep.capacity_tag || "";

    const rankSelect = document.createElement("select");
    buildOptions(rankSelect, rankOptions, dep.rank || "");
    rankSelect.style.display = "none";

    const capabilitySelect = document.createElement("select");
    buildOptions(capabilitySelect, capabilityOptions, dep.capacity_tag || "");
    capabilitySelect.style.display = "none";

    const statusTd = document.createElement("td");
    statusTd.appendChild(renderStatusControls(dep, tr));

    const actionsTd = document.createElement("td");

    const editBtn = document.createElement("button");
    editBtn.type = "button";
    editBtn.textContent = "Edit";

    const saveBtn = document.createElement("button");
    saveBtn.type = "button";
    saveBtn.textContent = "Save";
    saveBtn.style.display = "none";

    editBtn.addEventListener("click", () => {
        rankDisplay.style.display = "none";
        capabilityDisplay.style.display = "none";
        rankSelect.style.display = "inline-block";
        capabilitySelect.style.display = "inline-block";
        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
    });

    saveBtn.addEventListener("click", () => {
        fetch("/api/upsert-deputy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                original_full_name: dep.full_name,
                full_name: dep.full_name,
                division: dep.division || "",
                rank: rankSelect.value,
                capacity_tag: capabilitySelect.value
            })
        }).then(() => loadRoster());
    });

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "Remove";
    removeBtn.addEventListener("click", () => {
        if (!confirm(`Remove ${dep.full_name}?`)) return;
        fetch("/api/delete-deputy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ full_name: dep.full_name })
        }).then(() => loadRoster());
    });

    actionsTd.appendChild(editBtn);
    actionsTd.appendChild(saveBtn);
    actionsTd.appendChild(removeBtn);

    tr.appendChild(Object.assign(document.createElement("td"), { textContent: dep.full_name || "" }));
    if (includeDivision) tr.appendChild(Object.assign(document.createElement("td"), { textContent: dep.division || "Unassigned Division" }));

    const rankTd = document.createElement("td");
    rankTd.appendChild(rankDisplay);
    rankTd.appendChild(rankSelect);
    tr.appendChild(rankTd);

    const capabilityTd = document.createElement("td");
    capabilityTd.appendChild(capabilityDisplay);
    capabilityTd.appendChild(capabilitySelect);
    tr.appendChild(capabilityTd);

    tr.appendChild(statusTd);
    tr.appendChild(actionsTd);

    return tr;
}

function updateCourtSecurityStatusCounts(deputies) {
    const cs = deputies.filter(isCourtSecurityDeputy);
    const sick = cs.filter(dep => statusIncludes(dep, "Sick")).length;
    const leave = cs.filter(dep => statusIncludes(dep, "Leave")).length;
    const lightDuty = cs.filter(dep => statusIncludes(dep, "Light Duty")).length;
    const total = cs.length;
    const available = total - sick - leave - lightDuty;

    document.getElementById("courtSecurityStatusCounts").innerHTML =
        `<span class="status-red">Sick ${sick}</span> /
        <span class="status-red">Leave ${leave}</span> /
        <span class="status-red">Light Duty ${lightDuty}</span> /
        <span class="status-green">Available ${available}</span>`;
}

function loadRoster() {
    const date = document.getElementById("rosterDate").value;
    fetch(`/api/deputies?date=${date}`)
        .then(res => res.json())
        .then(data => {
            const deputies = (data || []).sort((a, b) => (a.full_name || "").localeCompare(b.full_name || ""));

            const csBody = document.querySelector("#courtSecurityTable tbody");
            const otherBody = document.querySelector("#otherDivisionsTable tbody");
            csBody.innerHTML = "";
            otherBody.innerHTML = "";

            deputies.forEach(dep => {
                if (isCourtSecurityDeputy(dep)) {
                    csBody.appendChild(createDeputyRow(dep, false));
                } else {
                    otherBody.appendChild(createDeputyRow(dep, true));
                }
            });

            updateCourtSecurityStatusCounts(deputies);
        });
}

document.getElementById("addDeputyBtn").addEventListener("click", () => {
    const fullName = document.getElementById("newFullName").value.trim();
    if (!fullName) {
        alert("Enter full name");
        return;
    }

    fetch("/api/upsert-deputy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            full_name: fullName,
            division: document.getElementById("newDivision").value,
            rank: document.getElementById("newRank").value,
            capacity_tag: document.getElementById("newCapability").value
        })
    }).then(() => {
        document.getElementById("newFullName").value = "";
        loadRoster();
    });
});

document.getElementById("rosterDate").addEventListener("change", loadRoster);
document.getElementById("rosterDate").value = new Date().toISOString().split("T")[0];
loadRoster();
</script>

</body>
</html>
